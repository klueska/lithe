# Makefile for parlib tests

TESTS_EXECS = bthread_test

TESTSNAME = $(LIBNAME)_bthread_tests
TESTS_SRCDIR := $(SCHEDS_DIR)/tests
TESTS_OBJDIR := $(OBJDIR)/tests

TESTS_CFLAGS = -O2 -Wall -std=gnu99 -MMD -MP
TESTS_LDFLAGS = -L$(OBJDIR) -L$(PARLIB_LDDIR) $(TESTS_LDLIBS)

TESTS_INCDIRS := . $(PARLIB_DIR) $(SCHEDS_DIR)
TESTS_INCS    := $(patsubst %, -I%, $(TESTS_INCDIRS))
TESTS_CFILES  := $(notdir $(wildcard $(TESTS_SRCDIR)/*.c))
TESTS_EXECS   := $(patsubst %, $(TESTS_OBJDIR)/%, $(TESTS_EXECS))

TESTS_DEPS = $(patsubst %, %.d, $(TESTS_EXECS))
-include $(TESTS_DEPS)

tests: all $(TESTS_EXECS)

$(TESTS_OBJDIR)/%: $(TESTS_SRCDIR)/%.c
	@echo + cc [$(call uc, $(TESTSNAME))] $(<F)
	@mkdir -p $(@D)
	$(V)$(CC) $< $(TESTS_CFLAGS) $(TESTS_INCS) $(TESTS_LDFLAGS) -o $@

tests_clean:
	@echo + clean [$(call uc, $(TESTSNAME))] $<
	$(V)rm -rf $(TESTS_OBJDIR)

